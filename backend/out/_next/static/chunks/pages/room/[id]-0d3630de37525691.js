(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[120],{9448:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/room/[id]",function(){return n(5783)}])},8418:function(e,t,n){"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(s){o=!0,c=s}finally{try{r||null==i.return||i.return()}finally{if(o)throw c}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}t.default=void 0;var o,c=(o=n(7294))&&o.__esModule?o:{default:o},a=n(6273),i=n(387),s=n(7190);var u={};function l(e,t,n,r){if(e&&a.isLocalURL(t)){e.prefetch(t,n,r).catch((function(e){0}));var o=r&&"undefined"!==typeof r.locale?r.locale:e&&e.locale;u[t+"%"+n+(o?"%"+o:"")]=!0}}var f=function(e){var t,n=!1!==e.prefetch,o=i.useRouter(),f=c.default.useMemo((function(){var t=r(a.resolveHref(o,e.href,!0),2),n=t[0],c=t[1];return{href:n,as:e.as?a.resolveHref(o,e.as):c||n}}),[o,e.href,e.as]),d=f.href,m=f.as,p=e.children,h=e.replace,v=e.shallow,x=e.scroll,y=e.locale;"string"===typeof p&&(p=c.default.createElement("a",null,p));var g=(t=c.default.Children.only(p))&&"object"===typeof t&&t.ref,j=r(s.useIntersection({rootMargin:"200px"}),2),w=j[0],b=j[1],N=c.default.useCallback((function(e){w(e),g&&("function"===typeof g?g(e):"object"===typeof g&&(g.current=e))}),[g,w]);c.default.useEffect((function(){var e=b&&n&&a.isLocalURL(d),t="undefined"!==typeof y?y:o&&o.locale,r=u[d+"%"+m+(t?"%"+t:"")];e&&!r&&l(o,d,m,{locale:t})}),[m,d,b,y,n,o]);var _={ref:N,onClick:function(e){t.props&&"function"===typeof t.props.onClick&&t.props.onClick(e),e.defaultPrevented||function(e,t,n,r,o,c,i,s){("A"!==e.currentTarget.nodeName||!function(e){var t=e.currentTarget.target;return t&&"_self"!==t||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||e.nativeEvent&&2===e.nativeEvent.which}(e)&&a.isLocalURL(n))&&(e.preventDefault(),null==i&&r.indexOf("#")>=0&&(i=!1),t[o?"replace":"push"](n,r,{shallow:c,locale:s,scroll:i}))}(e,o,d,m,h,v,x,y)},onMouseEnter:function(e){t.props&&"function"===typeof t.props.onMouseEnter&&t.props.onMouseEnter(e),a.isLocalURL(d)&&l(o,d,m,{priority:!0})}};if(e.passHref||"a"===t.type&&!("href"in t.props)){var k="undefined"!==typeof y?y:o&&o.locale,E=o&&o.isLocaleDomain&&a.getDomainLocale(m,k,o&&o.locales,o&&o.domainLocales);_.href=E||a.addBasePath(a.addLocale(m,k,o&&o.defaultLocale))}return c.default.cloneElement(t,_)};t.default=f},7190:function(e,t,n){"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(s){o=!0,c=s}finally{try{r||null==i.return||i.return()}finally{if(o)throw c}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}Object.defineProperty(t,"__esModule",{value:!0}),t.useIntersection=function(e){var t=e.rootMargin,n=e.disabled||!a,s=o.useRef(),u=r(o.useState(!1),2),l=u[0],f=u[1],d=o.useCallback((function(e){s.current&&(s.current(),s.current=void 0),n||l||e&&e.tagName&&(s.current=function(e,t,n){var r=function(e){var t=e.rootMargin||"",n=i.get(t);if(n)return n;var r=new Map,o=new IntersectionObserver((function(e){e.forEach((function(e){var t=r.get(e.target),n=e.isIntersecting||e.intersectionRatio>0;t&&n&&t(n)}))}),e);return i.set(t,n={id:t,observer:o,elements:r}),n}(n),o=r.id,c=r.observer,a=r.elements;return a.set(e,t),c.observe(e),function(){a.delete(e),c.unobserve(e),0===a.size&&(c.disconnect(),i.delete(o))}}(e,(function(e){return e&&f(e)}),{rootMargin:t}))}),[n,t,l]);return o.useEffect((function(){if(!a&&!l){var e=c.requestIdleCallback((function(){return f(!0)}));return function(){return c.cancelIdleCallback(e)}}}),[l]),[d,l]};var o=n(7294),c=n(9311),a="undefined"!==typeof IntersectionObserver;var i=new Map},5783:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return y}});var r=n(5666),o=n.n(r),c=n(5893),a=n(9008),i=(n(1664),n(1163)),s=n(7294),u=n(7015),l=n(2804),f=n(2033),d=n(9707),m=n(5303);function p(e,t,n,r,o,c,a){try{var i=e[c](a),s=i.value}catch(u){return void n(u)}i.done?t(s):Promise.resolve(s).then(r,o)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var c=e.apply(t,n);function a(e){p(c,r,o,a,i,"next",e)}function i(e){p(c,r,o,a,i,"throw",e)}a(void 0)}))}}function v(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(s){o=!0,c=s}finally{try{r||null==i.return||i.return()}finally{if(o)throw c}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function x(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function y(e){var t=(0,i.useRouter)(),n=v((0,l.FV)(u.KL),2),r=n[0],p=(n[1],(0,s.useState)([])),y=p[0],g=p[1],j=(0,s.useRef)(),w=(0,s.useRef)([]),b=(0,s.useRef)([]),N=t.query.id,_=(0,s.useRef)(null),k=(0,s.useState)(!1),E=k[0],S=k[1],O=(0,s.useState)([]),A=O[0],C=O[1],L=(0,s.useState)(""),I=L[0],M=L[1],T=(0,s.useState)([]),R=T[0],P=T[1];(0,s.useEffect)(h(o().mark((function e(){var t;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=localStorage.getItem("token"),j.current=new WebSocket("ws://".concat(f.O9,"/ws")),j.current.addEventListener("open",(function(e){j.current.send(JSON.stringify({command:0,data:{token:t}}))})),j.current.addEventListener("message",(function(e){try{var t=JSON.parse(e.data),n=t.command;if(null!=n)switch(n){case 1:console.log(t.message);var r=t.message,o=w.current.filter((function(e){return e.id===r.user_id}));if(null!=(o=o[0])){var c={text:r.text,from_id:o.id,from:o.name,icon:o.icon,timestamp:new Date};P(x(b.current).concat([c]))}else console.log("no valid user")}}catch(a){console.log(a)}})),e.abrupt("return",(function(){console.log("Disconnecting.."),j.current.close()}));case 5:case"end":return e.stop()}}),e)}))),[]),(0,s.useEffect)((function(){null!=r&&(h(o().mark((function e(){var t,n,r,c,a,i,s,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=localStorage.getItem("token"),E){e.next=31;break}return e.next=4,fetch("http://".concat(f.O9,"/restricted/get_rooms"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({room_ids:[N]})}).catch((function(){return null}));case 4:if(null==(n=e.sent)){e.next=31;break}return e.next=8,n.json().catch((function(){return null}));case 8:if(null==(r=e.sent).result){e.next=31;break}if(0!==r.result){e.next=31;break}return S(!0),c=r.rooms,C(c[0]),e.next=16,fetch("http://".concat(f.O9,"/restricted/get_roomusers"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({room_id:N})}).catch((function(){return null}));case 16:if(null==(n=e.sent)){e.next=31;break}return e.next=20,n.json().catch((function(){return null}));case 20:return a=e.sent,g(a.users),i=a.users,e.next=25,fetch("http://".concat(f.O9,"/restricted/get_messages"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({room_ids:[N]})}).catch((function(){return null}));case 25:if(null==(n=e.sent)){e.next=31;break}return e.next=29,n.json().catch((function(){return null}));case 29:null!=(s=e.sent).result&&0===s.result&&(P([]),u=x(R),s.messages.map((function(e,t){var n=i.filter((function(t){return t.id===e.user_id}));if(null!=(n=n[0])){var r={text:e.text,from_id:n.id,from:n.name,icon:n.icon,timestamp:new Date(e.CreatedAt)};u.push(r)}else console.log("no valid user")})),P(u));case 31:case"end":return e.stop()}}),e)})))(),null!=_.current&&_.current.scrollIntoView())}),[A,R,_,r,y]),(0,s.useEffect)((function(){w.current=x(y)}),[y]),(0,s.useEffect)((function(){b.current=x(R)}),[R]);var z=h(o().mark((function e(t){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("hello"),j.current.send(JSON.stringify({command:1,message:{room_id:N,user_id:r.id,text:I}})),M(""),_.current.scrollIntoView();case 4:case"end":return e.stop()}}),e)})));return(0,c.jsx)(d.Z,{children:null==r?(0,c.jsx)("div",{children:"loading"}):(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-screen w-screen",children:[(0,c.jsxs)(a.default,{children:[(0,c.jsx)("title",{children:"\u90e8\u5c4b\u4e00\u89a7"}),(0,c.jsx)("meta",{"http-equiv":"cache-control",content:"no-cache"}),(0,c.jsx)("meta",{"http-equiv":"expires",content:"0"}),(0,c.jsx)("meta",{"http-equiv":"pragma",content:"no-cache"})]}),(0,c.jsx)(m.Z,{title:A.name}),(0,c.jsxs)("main",{className:"flex flex-col items-center justify-start w-full flex-1 container bg-zinc-100 pt-4 pb-40",children:[R.map((function(e,t){return e.from_id!=r.id?(0,c.jsxs)("div",{className:"flex justify-start w-full pr-8 py-2",children:[(0,c.jsx)("div",{className:"",children:(0,c.jsx)("div",{className:"w-10 h-10 shadow-lg rounded-full p-2 mx-2",children:""==e.icon?(0,c.jsx)("img",{src:f.FK,alt:"",width:80,height:80}):(0,c.jsx)("img",{src:e.icon,alt:"",width:80,height:80})})}),(0,c.jsxs)("div",{className:"flex flex-col justify-start",children:[(0,c.jsx)("div",{className:"text-xs",children:e.from}),(0,c.jsxs)("div",{className:"flex",children:[(0,c.jsx)("div",{className:"bg-zinc-500 text-white rounded-xl px-2 py-1 my-auto",children:(0,c.jsx)("p",{className:"text-sm",children:e.text})}),(0,c.jsx)("div",{className:"ml-2 flex flex-col justify-end",children:(0,c.jsx)("p",{className:"text-xs",children:"".concat(("0"+e.timestamp.getHours()).slice(-2),":").concat(("0"+e.timestamp.getMinutes()).slice(-2))})})]})]})]},t):(0,c.jsxs)("div",{className:"flex justify-end w-full pl-8 pr-4 py-2",children:[(0,c.jsx)("div",{className:"mr-2 flex flex-col justify-end",children:(0,c.jsx)("p",{className:"text-xs",children:"".concat(("0"+e.timestamp.getHours()).slice(-2),":").concat(("0"+e.timestamp.getMinutes()).slice(-2))})}),(0,c.jsx)("div",{className:"bg-green-300 rounded-xl px-2 py-1 my-auto",children:(0,c.jsx)("p",{className:"text-sm",children:e.text})})]},t)})),(0,c.jsx)("div",{ref:_})]}),(0,c.jsx)("div",{className:"sticky bottom-0 container",children:(0,c.jsx)("div",{className:"my-2",children:(0,c.jsxs)("div",{className:"flex w-full justify-end",children:[(0,c.jsx)("input",{className:"border-2 flex-grow mx-2 py-2 px-2",value:I,onChange:function(e){M(e.target.value)}}),(0,c.jsx)("button",{className:"text-sm w-12 bg-neutral-800 rounded-md mx-2 text-white",onClick:z,children:"\u9001\u4fe1"})]})})})]})})}},9008:function(e,t,n){e.exports=n(5443)},1664:function(e,t,n){e.exports=n(8418)},1163:function(e,t,n){e.exports=n(387)}},function(e){e.O(0,[533,774,888,179],(function(){return t=9448,e(e.s=t);var t}));var t=e.O();_N_E=t}]);